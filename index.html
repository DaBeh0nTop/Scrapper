<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Data Pair Cleaner</title>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
  /* ============== THEME ============== */
  :root{
    --bg1:#0b1020; --bg2:#000000; --panel:#0f1630cc; --borderC:#17e7ff;
    --muted:#9eb3ca; --cyan:#17e7ff; --mag:#ff3df0; --yel:#ffe64d;
    --red:#ff596e; --green:#46ffa2;
    --radius:14px; --radius-sm:10px;
    --pad:14px; --gap:14px;
    --shadow:0 8px 26px rgba(0,0,0,.35), inset 0 0 0 1px rgba(255,255,255,.02);
    --ring:0 0 0 2px rgba(23,231,255,.35), 0 0 26px rgba(23,231,255,.18);
    --text: clamp(13px, 1.4vw, 14px);
    --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
  }
  *,*::before,*::after{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:#eef6ff; font-family: Inter, "Segoe UI", system-ui, -apple-system, Arial, sans-serif;
    font-size: var(--text);
    background:
      radial-gradient(1000px 600px at 15% -10%, #13305a 0%, transparent 55%),
      linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 70%);
    min-height:100dvh;
  }
  a{color:var(--cyan); text-decoration:none}
  /* ============== LAYOUT ============== */
  .wrap{
    display:grid; grid-template-rows:auto 1fr auto;
    min-height:100dvh; gap:var(--gap); padding:calc(var(--gap) + env(safe-area-inset-top)) var(--gap) calc(64px + var(--gap) + env(safe-area-inset-bottom));
  }
  .header{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .brand{display:flex; gap:10px; align-items:center}
  .brand h1{margin:0; font-size:clamp(18px,2.2vw,22px); color:var(--cyan); letter-spacing:.3px}
  .brand p{margin:0; color:var(--muted); font-size:12px}
  .tally{display:flex; gap:12px; font-weight:800}
  .tally span{white-space:nowrap}
  .t-valid{color:var(--green)} .t-invalid{color:var(--red)} .t-dupes{color:var(--yel)}

  /* MOBILE-FIRST: one column; desktop upgrades to 2 columns */
  .grid{
    display:grid; grid-template-columns:1fr; gap:var(--gap);
  }
  @media (min-width: 980px){
    .grid{ grid-template-columns: 420px 1fr; }
  }

  .panel{
    background:var(--panel); border:1px solid rgba(23,231,255,.22);
    border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden;
  }
  .head{
    display:flex; align-items:center; justify-content:space-between;
    padding:10px var(--pad);
    border-bottom:1px solid rgba(255,255,255,.06);
    background:linear-gradient(180deg, rgba(255,255,255,.04), transparent);
  }
  .head h3{margin:0; font-size:12px; letter-spacing:.4px; text-transform:uppercase; color:#dbf6ff}
  .content{padding:var(--pad)}

  /* Upload */
  .upload{
    border:2px dashed var(--borderC); border-radius:var(--radius);
    padding:22px; text-align:center; cursor:pointer; transition:.2s;
    background:#0a1126;
  }
  .upload:hover,.upload.drag{box-shadow:var(--ring)}
  .upload p{margin:6px 0 0; color:var(--muted); font-size:12px}
  .queue{max-height:220px; overflow:auto; -webkit-overflow-scrolling:touch}
  .q-item{
    display:grid; grid-template-columns:1fr auto; gap:8px; padding:10px 8px;
    border-bottom:1px solid rgba(255,255,255,.06);
  }
  .status{color:var(--yel); font-weight:700}

  /* Controls */
  .controls .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .seg{display:flex; gap:6px; background:#0a1126; border:1px solid rgba(255,255,255,.06); border-radius:var(--radius-sm); padding:6px}
  .seg label{display:flex; align-items:center}
  .seg input{display:none}
  .seg span{padding:8px 10px; border-radius:10px; cursor:pointer; user-select:none}
  .seg input:checked + span{background:#182240; border:1px solid rgba(23,231,255,.35)}

  .consent{display:flex; align-items:center; gap:8px; color:#ffd7db}
  .switch{display:flex; gap:8px; flex-wrap:wrap}
  .switch label{
    display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px;
    background:#0a1126; border:1px solid rgba(255,255,255,.06);
  }

  button{
    appearance:none; -webkit-tap-highlight-color:transparent;
    background:linear-gradient(180deg, #1ef1ff, #14b1ff); color:#001018;
    border:0; border-radius:12px; padding:12px 16px; font-weight:900; letter-spacing:.3px;
    box-shadow:0 6px 18px rgba(20,177,255,.28); cursor:pointer; transition:transform .12s, opacity .12s;
    min-height:44px;
  }
  button.secondary{
    background:linear-gradient(180deg, #222a45, #192038); color:#e9f7ff;
    border:1px solid rgba(255,255,255,.08); box-shadow:none;
  }
  button.danger{
    background:linear-gradient(180deg, #ff6e7c, #ff445c); color:#150408;
  }
  button:disabled{opacity:.5; transform:none; cursor:not-allowed}
  button:active{transform:translateY(1px)}

  .progress{height:10px; background:#0b0f1e; border-radius:8px; overflow:hidden; border:1px solid rgba(255,255,255,.06)}
  .bar{height:100%; width:0%; background:linear-gradient(90deg, var(--cyan), var(--mag)); transition:width .25s}

  /* Results / Errors / Preview / Log */
  .cols{display:grid; grid-template-columns:1fr; gap:var(--gap)}
  @media (min-width: 980px){ .cols{ grid-template-columns: 1fr 360px; } }
  .result-list{max-height:48vh; overflow:auto; -webkit-overflow-scrolling:touch; contain: content; }
  .row-item{
    display:grid; grid-template-columns:auto 1fr auto auto; gap:10px; align-items:center;
    padding:10px 8px; border-bottom:1px solid rgba(255,255,255,.06);
  }
  .email{color:var(--cyan)} .tok{color:var(--mag)} .lvl{color:var(--yel)}
  .tok.masked{filter:blur(3px)}
  .src{color:#8ea0bb; font-size:12px}
  .err-list{max-height:28vh; overflow:auto; background:#0a0f1f; border:1px dashed rgba(255,255,255,.08); border-radius:12px; padding:10px}
  .err{color:var(--red); font-size:12px; border-bottom:1px dotted rgba(255,255,255,.08); padding:6px 0}
  .preview{
    background:#0b0f1e; border-radius:12px; border:1px solid rgba(255,255,255,.06);
    padding:10px; min-height:84px; font-family:var(--mono); font-size:12px; white-space:pre-wrap;
  }
  .hl-email{background:rgba(23,231,255,.25); padding:0 2px}
  .hl-token{background:rgba(255,61,240,.25); padding:0 2px}
  .hl-level{background:rgba(255,230,77,.25); padding:0 2px}
  .log{max-height:28vh; overflow:auto; background:#0b0f1e; border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:10px; font-size:12px}
  .log .item{border-bottom:1px dotted rgba(255,255,255,.08); padding:6px 4px}
  .log .ts{color:#9fcaff; margin-right:6px}

  /* Sticky mobile action bar (bottom) */
  .actionbar{
    position:fixed; left:0; right:0; bottom:0;
    padding:8px calc(10px + env(safe-area-inset-right)) calc(8px + env(safe-area-inset-bottom)) calc(10px + env(safe-area-inset-left));
    background:linear-gradient(180deg, transparent, rgba(0,0,0,.65) 18%), #0b0f1e;
    border-top:1px solid rgba(255,255,255,.08);
    display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; z-index:20;
  }
  @media (min-width:980px){
    .actionbar{display:none}
  }

  .footer{color:var(--muted); font-size:12px; text-align:center; padding-bottom:env(safe-area-inset-bottom)}
</style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none"><path d="M3 12h18M3 6h12M3 18h12" stroke="#17e7ff" stroke-width="2" stroke-linecap="round"/></svg>
        <div>
          <h1>Data Pair Cleaner</h1>
          <p>Client-side normalization • de-duplication • full audit exports</p>
        </div>
      </div>
      <div class="tally">
        <span class="t-valid">Valid: <b id="tValid">0</b></span>
        <span class="t-invalid">Invalid: <b id="tInvalid">0</b></span>
        <span class="t-dupes">Dupes: <b id="tDupes">0</b></span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Inputs -->
      <div class="panel">
        <div class="head"><h3>Input & Controls</h3></div>
        <div class="content controls">
          <div id="upload" class="upload" tabindex="0">
            <strong>Tap or Drag & Drop files</strong>
            <p>TXT, CSV, LOG • Processed locally on your device</p>
            <input id="file" type="file" multiple accept=".txt,.csv,.log" hidden />
          </div>

          <div class="row" style="margin-top:10px">
            <div class="seg" role="radiogroup" aria-label="Mode">
              <label><input type="radio" name="mode" value="fast" checked><span>Fast</span></label>
              <label><input type="radio" name="mode" value="slow"><span>Slow (visual)</span></label>
            </div>
            <div class="consent">
              <input id="consent" type="checkbox">
              <label for="consent">I own or have permission to process these files</label>
            </div>
          </div>

          <div class="row" style="margin-top:6px">
            <div class="switch">
              <label><input id="onlyValid" type="checkbox"> <span>Only Valid</span></label>
              <label><input id="maskTokens" type="checkbox" checked> <span>Mask Tokens</span></label>
              <label><input id="proDedup" type="checkbox" checked> <span>Pro De-Dupe</span></label>
              <label><input id="appendLevel" type="checkbox" checked> <span>Append Level</span></label>
            </div>
          </div>

          <div class="row" style="width:100%; margin-top:8px">
            <div class="progress" style="flex:1"><div id="bar" class="bar"></div></div>
          </div>

          <div class="panel" style="margin-top:12px; background:#0a0f1f; border:1px solid rgba(255,255,255,.06)">
            <div class="head"><h3>Queue</h3></div>
            <div class="content"><div id="queue" class="queue"></div></div>
          </div>

          <div class="row" style="gap:8px; margin-top:10px">
            <!-- Desktop action buttons -->
            <button id="play" aria-label="Play">Play</button>
            <button id="stop" class="secondary" disabled>Stop</button>
            <button id="clearAll" class="secondary">Clear</button>
            <button id="copyAll" class="secondary" disabled>Copy All</button>
            <button id="exportZip" disabled>Export ZIP</button>
          </div>
        </div>
      </div>

      <!-- RIGHT: Results -->
      <div class="panel">
        <div class="head"><h3>Results & Audit</h3></div>
        <div class="content">
          <div class="cols">
            <div>
              <div class="row" style="gap:8px; margin-bottom:8px">
                <button id="selectAll" class="secondary" disabled>Select All</button>
                <button id="deselectAll" class="secondary" disabled>Deselect All</button>
                <button id="removeSelected" class="danger" disabled>Remove Selected</button>
              </div>

              <div id="results" class="result-list" aria-live="polite"></div>

              <div class="panel" style="margin-top:12px; background:#0a0f1f; border:1px solid rgba(255,255,255,.06)">
                <div class="head"><h3>Errors</h3></div>
                <div class="content">
                  <div id="errors" class="err-list"></div>
                  <div class="row" style="margin-top:8px">
                    <button id="clearErrors" class="secondary">Clear Errors</button>
                  </div>
                </div>
              </div>
            </div>

            <div>
              <div class="panel" style="background:#0a0f1f; border:1px solid rgba(255,255,255,.06)">
                <div class="head"><h3>Live Preview (Slow)</h3></div>
                <div class="content"><div id="preview" class="preview">—</div></div>
              </div>
              <div class="panel" style="margin-top:12px; background:#0a0f1f; border:1px solid rgba(255,255,255,.06)">
                <div class="head"><h3>Action Log (Slow)</h3></div>
                <div class="content">
                  <div id="log" class="log" aria-live="polite"></div>
                  <div class="row" style="margin-top:8px"><button id="clearLog" class="secondary">Clear Log</button></div>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

    <!-- Sticky mobile action bar -->
    <div class="actionbar" role="toolbar" aria-label="Quick actions">
      <button id="mPlay">Play</button>
      <button id="mStop" class="secondary" disabled>Stop</button>
      <button id="mExport">Export</button>
    </div>

    <div class="footer">Local-only processing. Export includes pairs.txt, pairs.csv, errors.txt, summary.json.</div>
  </div>

<script>
(() => {
  // ===== Shortcuts =====
  const $ = s => document.querySelector(s);
  const el = (t, p={}) => Object.assign(document.createElement(t), p);
  const sleep = ms => new Promise(r => setTimeout(r, ms));
  const iso = () => new Date().toISOString();

  // ===== Normalizers =====
  function normalizeEmail(raw){
    if(!raw) return "";
    let email = String(raw).trim().toLowerCase();
    const m = email.match(/^([^@]+)@(.+)$/);
    if(!m) return email;
    let [_, local, domain] = m;
    if(domain === "gmail.com" || domain === "googlemail.com"){
      local = local.replace(/\./g,"").replace(/\+.*$/,"");
      domain = "gmail.com";
    }
    return `${local}@${domain}`.replace(/^\d+\./,""); // strip numeric prefix before email
  }
  function normalizeToken(raw){
    if(!raw) return "";
    return String(raw).trim().replace(/[^a-zA-Z0-9]/g,""); // remove =>, ==> etc.
  }
  function splitCSVLine(line){
    const out=[]; let cur=""; let q=false;
    for(let i=0;i<line.length;i++){
      const c=line[i];
      if(c === '"'){ q = !q; continue; }
      if(c === ',' && !q){ out.push(cur.trim()); cur=""; continue; }
      cur += c;
    }
    out.push(cur.trim());
    return out;
  }

  // ===== App =====
  class Cleaner {
    constructor(){
      // State
      this.files=[];
      this.results=[]; // {email, token, level, source, raw, valid, selected}
      this.errors=[];
      this.map=new Map(); // key -> idx
      this.total=0; this.done=0;
      this.mode="fast";
      this.running=false;
      this.stopFlag=false;

      // UI refs
      this.$queue=$("#queue"); this.$results=$("#results"); this.$errors=$("#errors");
      this.$bar=$("#bar"); this.$preview=$("#preview"); this.$log=$("#log");
      this.$tValid=$("#tValid"); this.$tInvalid=$("#tInvalid"); this.$tDupes=$("#tDupes");

      // Options
      this.opts={
        consent: $("#consent"), onlyValid: $("#onlyValid"), mask: $("#maskTokens"),
        dedup: $("#proDedup"), appendLevel: $("#appendLevel")
      };

      // Buttons (desktop)
      this.btn={ play:$("#play"), stop:$("#stop"), clear:$("#clearAll"),
                 copy:$("#copyAll"), export:$("#exportZip"),
                 sel:$("#selectAll"), desel:$("#deselectAll"), rm:$("#removeSelected") };
      // Mobile bar
      this.mbtn={ play:$("#mPlay"), stop:$("#mStop"), export:$("#mExport") };

      this.bind();
      this.updateButtons();
    }

    bind(){
      // Upload
      const up=$("#upload"), file=$("#file");
      up.addEventListener("click", ()=> file.click());
      ["dragover","dragenter"].forEach(evn=> up.addEventListener(evn, e=>{ e.preventDefault(); up.classList.add("drag"); }));
      ["dragleave","drop"].forEach(evn=> up.addEventListener(evn, e=>{ e.preventDefault(); up.classList.remove("drag"); }));
      up.addEventListener("drop", e=>{
        const fs=[...e.dataTransfer.files].filter(f=>/\.(txt|csv|log)$/i.test(f.name));
        if(fs.length) this.setFiles(fs);
      });
      file.addEventListener("change", e=>{
        const fs=[...e.target.files].filter(f=>/\.(txt|csv|log)$/i.test(f.name));
        if(fs.length) this.setFiles(fs);
        file.value="";
      });

      // Mode
      document.querySelectorAll('input[name="mode"]').forEach(r =>
        r.addEventListener("change", ()=>{
          this.mode = document.querySelector('input[name="mode"]:checked').value;
          this.log(`Mode: ${this.mode.toUpperCase()}`);
        })
      );

      // Toggles
      Object.values(this.opts).forEach(input => input.addEventListener("change", ()=> this.renderResults()));

      // Buttons desktop
      this.btn.play.addEventListener("click", ()=> this.start());
      this.btn.stop.addEventListener("click", ()=> this.stop());
      this.btn.clear.addEventListener("click", ()=> this.clear());
      this.btn.copy.addEventListener("click", ()=> this.copyAll());
      this.btn.export.addEventListener("click", ()=> this.exportZip());
      this.btn.sel.addEventListener("click", ()=> this.selectAll(true));
      this.btn.desel.addEventListener("click", ()=> this.selectAll(false));
      this.btn.rm.addEventListener("click", ()=> this.removeSelected());
      $("#clearErrors").addEventListener("click", ()=> { this.errors=[]; this.renderErrors(); });
      $("#clearLog").addEventListener("click", ()=> { this.$log.innerHTML=""; });

      // Buttons mobile
      this.mbtn.play.addEventListener("click", ()=> this.start());
      this.mbtn.stop.addEventListener("click", ()=> this.stop());
      this.mbtn.export.addEventListener("click", ()=> this.exportZip());

      // Consent
      this.opts.consent.addEventListener("change", ()=> this.updateButtons());

      // Passive scroll perf
      ["results","errors","queue","log"].forEach(id=>{
        const n = document.getElementById(id);
        n && n.addEventListener("touchstart", ()=>{}, {passive:true});
      });
    }

    setFiles(fs){
      this.files = fs.map(f=>({file:f, name:f.name, status:"Queued"}));
      this.results=[]; this.errors=[]; this.map.clear(); this.total=0; this.done=0;
      this.renderQueue(); this.renderResults(); this.renderErrors(); this.updateTallies();
      this.$bar.style.width="0%";
      this.updateButtons();
    }

    renderQueue(){
      this.$queue.innerHTML = this.files.map(f=>`
        <div class="q-item">
          <div>${this.escape(f.name)}</div>
          <div class="status">${f.status}</div>
        </div>
      `).join("") || `<div style="color:#8ea0bb">No files added.</div>`;
    }

    updateButtons(){
      const ok = this.opts.consent.checked && this.files.length>0 && !this.running;
      this.btn.play.disabled = !ok; this.mbtn.play.disabled = !ok;
      this.btn.stop.disabled = !this.running; this.mbtn.stop.disabled = !this.running;
      const hasRes = this.results.length>0, any = hasRes || this.errors.length>0;
      this.btn.copy.disabled = !hasRes;
      this.btn.export.disabled = !any; this.mbtn.export.disabled = !any;
      this.btn.sel.disabled = !hasRes; this.btn.desel.disabled = !hasRes; this.btn.rm.disabled = !hasRes;
    }

    async start(){
      if(this.running) return;
      if(!(this.opts.consent.checked && this.files.length)) return;
      this.running=true; this.stopFlag=false; this.updateButtons();
      this.log("Processing started.");

      for(let i=0;i<this.files.length;i++){
        if(this.stopFlag) break;
        const e=this.files[i];
        e.status="Reading"; this.renderQueue();
        const text = await e.file.text();
        e.status="Parsing"; this.renderQueue();

        const lines = text.split(/\r?\n/);
        this.total += lines.length;

        if(/\.csv$/i.test(e.name)){
          await this.processCSV(lines, e.name);
        } else {
          await this.processText(lines, e.name);
        }

        e.status="Done"; this.renderQueue();
      }

      this.running=false; this.log("Processing finished.");
      this.updateButtons(); this.renderResults(); this.renderErrors();
    }
    stop(){ if(!this.running) return; this.stopFlag=true; this.log("Stop requested."); }

    /* FAST == big chunks; SLOW == one-by-one with preview/log */
    async processText(lines, source){
      const chunk = this.mode==="fast" ? 700 : 1;
      for(let i=0;i<lines.length;i+=chunk){
        if(this.stopFlag) break;
        const slice = lines.slice(i, i+chunk);
        if(this.mode==="slow"){
          for(let j=0;j<slice.length;j++){
            if(this.stopFlag) break;
            await this.processLine(slice[j], source, i+j+1, true);
            this.done++; this.updateProgress(); await sleep(110);
          }
        } else {
          for(let j=0;j<slice.length;j++){
            this.processLine(slice[j], source, i+j+1, false);
            this.done++;
          }
          this.updateProgress(); await sleep(0);
        }
      }
    }
    async processCSV(lines, source){
      if(!lines.length) return;
      const header = splitCSVLine(lines[0].toLowerCase());
      const iE = header.indexOf("email");
      const iP = header.indexOf("pass")>=0 ? header.indexOf("pass") : header.indexOf("token");
      const iL = header.indexOf("level");
      const chunk = this.mode==="fast" ? 700 : 1;

      if(iE===-1 || iP===-1){ await this.processText(lines, source); return; }

      for(let i=1;i<lines.length;i+=chunk){
        if(this.stopFlag) break;
        const sl = lines.slice(i, i+chunk);
        if(this.mode==="slow"){
          for(let j=0;j<sl.length;j++){
            if(this.stopFlag) break;
            const raw = sl[j]; const row = splitCSVLine(raw);
            const email = normalizeEmail(row[iE]||"");
            const token = normalizeToken(row[iP]||"");
            const level = (iL>=0 && row[iL]) ? row[iL].trim() : null;
            await this.accept(email, token, level, source, raw, true);
            this.done++; this.updateProgress(); await sleep(110);
          }
        } else {
          for(let j=0;j<sl.length;j++){
            const raw = sl[j]; const row = splitCSVLine(raw);
            const email = normalizeEmail(row[iE]||"");
            const token = normalizeToken(row[iP]||"");
            const level = (iL>=0 && row[iL]) ? row[iL].trim() : null;
            this.accept(email, token, level, source, raw, false);
            this.done++;
          }
          this.updateProgress(); await sleep(0);
        }
      }
    }

    async processLine(line, source, lineNo, slow){
      const t = String(line||"").trim();
      if(!t || t.startsWith("#")) return;
      if(slow){ this.preview(t); this.log(`Line ${lineNo} • ${source}`); }

      // email:token[:level]
      let m = t.match(/([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,})\s*:\s*([^\s:]+)(?:\s*:\s*(\d+))?/);
      if(m){ return await this.accept(normalizeEmail(m[1]), normalizeToken(m[2]), m[3]||this.grabLevel(t), source, t, slow); }

      // blocks with Email: / Pass|Token: / Level|lvl:
      m = t.match(/(?:Email|email)\s*:\s*([a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}).*?(?:Pass|pass|Token|token)\s*:\s*([^\s:]+).*?(?:(?:Level|level|lvl)\s*:\s*(\d+))?/);
      if(m){ return await this.accept(normalizeEmail(m[1]), normalizeToken(m[2]), m[3]||this.grabLevel(t), source, t, slow); }

      if(/@/.test(t) && !/:\s*\S+/.test(t)){
        this.error(`[${source}] line ${lineNo}: email found without token :: ${t}`);
        if(slow) this.log(`Invalid • missing token (line ${lineNo})`);
        return;
      }
      this.error(`[${source}] line ${lineNo}: invalid format :: ${t}`);
      if(slow) this.log(`Invalid format (line ${lineNo})`);
    }

    grabLevel(s){ const m = s.match(/(?:lvl|level)\s*[:\-]?\s*(\d+)/i); return m? m[1] : null; }

    async accept(email, token, level, source, raw, slow){
      if(slow){
        this.preview(raw.replace(email, `<span class="hl-email">${email}</span>`));
        await sleep(120);
        this.preview(this.$preview.innerHTML.replace(token, `<span class="hl-token">${token}</span>`));
        await sleep(120);
        if(level){ const L=String(level); this.preview(this.$preview.innerHTML.replace(new RegExp(`(${L})(?![^<]*>)`), `<span class="hl-level">${L}</span>`)); await sleep(100); }
      }
      const ok = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email) && token.length>0;
      if(!ok){ this.error(`[${source}] invalid :: ${raw}`); if(slow) this.log(`Rejected ${email}`); return; }

      const key = `${email}::${token.toLowerCase()}`;
      if(this.opts.dedup.checked){
        if(this.map.has(key)){ if(slow) this.log(`Duplicate collapsed • ${email}`); return; }
        this.map.set(key, this.results.length);
      }

      this.results.push({email, token, level: level||null, source, raw, valid:true, selected:false});
      if(slow) this.log(`Accepted ${email}${level?` (lvl ${level})`:""}`);
      if(this.mode==="slow") this.renderResults();
    }

    // ===== Render =====
    renderResults(){
      const onlyValid = this.opts.onlyValid.checked;
      const mask = this.opts.mask.checked;
      const addL = this.opts.appendLevel.checked;

      // Build rows in fragments for perf on phones
      const frag = document.createDocumentFragment();
      const list = el("div");
      const items = (onlyValid? this.results.filter(x=>x.valid): this.results);

      list.innerHTML = items.map((r, i) => {
        const idx = i; // local index in filtered view
        const tok = mask ? `<span class="tok masked">••••••</span>` : `<span class="tok">${r.token}</span>`;
        return `
          <div class="row-item" data-i="${idx}">
            <input type="checkbox" ${r.selected?'checked':''} aria-label="select row">
            <div><span class="email">${r.email}</span> : ${tok}${r.level?` : <span class="lvl">${r.level}</span>`:""}</div>
            <div class="src">${r.source}</div>
            <div>
              <button class="secondary btn-copy" data-text="${this.escapeAttr(addL&&r.level?`${r.email}:${r.token}:${r.level}`:`${r.email}:${r.token}${r.level?':'+r.level:''}`)}">Copy</button>
              <button class="secondary btn-remove">Remove</button>
            </div>
          </div>
        `;
      }).join("");

      this.$results.replaceChildren(list);

      // Wire events only once per render
      this.$results.querySelectorAll(".row-item").forEach((row, viewIdx)=>{
        const cb = row.querySelector('input[type="checkbox"]');
        cb.addEventListener("change", ()=>{
          // Map back to original results index by locating the item
          const email = row.querySelector(".email").textContent;
          const s = row.querySelector(".src").textContent;
          const idx = this.results.findIndex(r=> r.email===email && r.source===s);
          if(idx>-1) this.results[idx].selected = cb.checked;
        });
        row.querySelector(".btn-copy").addEventListener("click", async (e)=>{
          const text = e.target.getAttribute("data-text"); await navigator.clipboard.writeText(text);
          e.target.textContent="Copied"; setTimeout(()=> e.target.textContent="Copy", 800);
        });
        row.querySelector(".btn-remove").addEventListener("click", ()=>{
          const email = row.querySelector(".email").textContent;
          const s = row.querySelector(".src").textContent;
          const idx = this.results.findIndex(r=> r.email===email && r.source===s);
          if(idx>-1) this.results.splice(idx,1);
          this.renderResults(); this.updateTallies();
        });
      });

      this.updateTallies(); this.updateButtons();
    }

    renderErrors(){
      this.$errors.innerHTML = this.errors.map(e=>`<div class="err">✖ ${this.escape(e)}</div>`).join("") || `<div style="color:#8ea0bb">No errors.</div>`;
      this.updateTallies(); this.updateButtons();
    }

    preview(html){ this.$preview.innerHTML = html || "—"; }
    updateProgress(){ const pct = this.total? Math.min(100, this.done/this.total*100) : 0; this.$bar.style.width = pct.toFixed(1)+'%'; }
    updateTallies(){
      const valid = this.results.length;
      const invalid = this.errors.length;
      const unique = this.map.size || valid; // when dedup off, approximate using valid
      const dupes = Math.max(0, this.done - invalid - unique);
      this.$tValid.textContent = String(valid);
      this.$tInvalid.textContent = String(invalid);
      this.$tDupes.textContent = String(dupes);
    }

    // ===== Actions =====
    selectAll(on=true){ this.results.forEach(r=> r.selected=on); this.renderResults(); }
    removeSelected(){ this.results = this.results.filter(r=> !r.selected); this.renderResults(); }
    async copyAll(){
      const onlyValid = this.opts.onlyValid.checked, addL = this.opts.appendLevel.checked;
      const lines = this.results.filter(r=> onlyValid? r.valid : true)
        .map(r => addL&&r.level? `${r.email}:${r.token}:${r.level}` : `${r.email}:${r.token}${r.level?':'+r.level:''}`);
      await navigator.clipboard.writeText(lines.join("\n"));
    }
    async exportZip(){
      const zip=new JSZip();
      const addL=this.opts.appendLevel.checked;
      const lines = this.results.map(r => addL&&r.level? `${r.email}:${r.token}:${r.level}` : `${r.email}:${r.token}${r.level?':'+r.level:''}`);
      const csv = ["email,token,level,valid,source"].concat(
        this.results.map(r => [`"${r.email.replace(/"/g,'""')}"`,
                               `"${r.token.replace(/"/g,'""')}"`,
                               `"${(r.level??"").toString().replace(/"/g,'""')}"`,
                               `"${r.valid}"`,
                               `"${r.source.replace(/"/g,'""')}"`].join(","))
      ).join("\n");
      const summary = {
        total_pairs: this.results.length + (Number(this.$tDupes.textContent)||0),
        valid: this.results.length,
        invalid: this.errors.length,
        duplicates_removed: (Number(this.$tDupes.textContent)||0),
        with_level: this.results.filter(r=> !!r.level).length,
        include_level_toggle: this.opts.appendLevel.checked,
        dedupe_enabled: this.opts.dedup.checked,
        timestamp: iso()
      };
      zip.file("pairs.txt", lines.join("\n"));
      zip.file("pairs.csv", csv);
      zip.file("errors.txt", this.errors.join("\n"));
      zip.file("summary.json", JSON.stringify(summary,null,2));
      const blob = await zip.generateAsync({type:"blob"});
      saveAs(blob, "grabbed_output.zip");
    }
    clear(){
      this.files=[]; this.results=[]; this.errors=[]; this.map.clear();
      this.total=0; this.done=0; this.$bar.style.width="0%";
      this.$queue.innerHTML = `<div style="color:#8ea0bb">No files added.</div>`;
      this.$results.innerHTML = `<div style="color:#8ea0bb">No results yet.</div>`;
      this.$errors.innerHTML = `<div style="color:#8ea0bb">No errors.</div>`;
      this.$preview.textContent = "—"; this.$log.innerHTML="";
      this.updateTallies(); this.updateButtons(); this.log("Cleared session.");
    }

    // ===== Log & Utils =====
    log(msg){
      if(this.mode!=="slow") return;
      const it = el("div",{className:"item"});
      it.innerHTML = `<span class="ts">${new Date().toLocaleTimeString()}</span><span>${this.escape(msg)}</span>`;
      this.$log.append(it); this.$log.scrollTop = this.$log.scrollHeight;
    }
    error(m){ this.errors.push(m); if(this.mode==="slow") this.renderErrors(); }
    escape(s){ return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }
    escapeAttr(s){ return String(s).replace(/"/g,"&quot;"); }
  }

  // Init
  const app = new Cleaner();
})();
</script>
</body>
</html>
